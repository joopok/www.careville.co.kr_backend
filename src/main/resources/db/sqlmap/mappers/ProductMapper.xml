<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.cleaning.mapper.ProductMapper">

    <!-- 상품 목록 전체 건수 조회 -->
    <select id="selectProductListCnt" parameterType="hashMap" resultType="int">
        SELECT COUNT(*) AS CNT
        FROM TB_PRODUCT P
        WHERE 1=1
          AND P.DEL_YN = 'N'
        <if test="searchType != null and searchType != '' and searchWord != null and searchWord != ''">
            <choose>
                <when test="searchType == 'productNm'">
                    AND P.PRODUCT_NM LIKE CONCAT('%', #{searchWord}, '%')
                </when>
                <when test="searchType == 'productNo'">
                    AND P.PRODUCT_NO = #{searchWord}
                </when>
            </choose>
        </if>
        <if test="serviceCd != null and serviceCd != ''">
            AND P.SERVICE_CD = #{serviceCd}
        </if>
        <if test="displayYn != null and displayYn != ''">
            AND P.DISPLAY_YN = #{displayYn}
        </if>
        <if test="saleYn != null and saleYn != ''">
            AND P.SALE_YN = #{saleYn}
        </if>
        <if test="areaType != null and areaType != ''">
            AND P.AREA_TYPE = #{areaType}
        </if>
    </select>

    <!-- 상품 목록 조회 -->
    <select id="selectProductList" parameterType="hashMap" resultType="hashMapCamel">
        SELECT
            P.PRODUCT_NO,
            P.SERVICE_CD,
            C.SERVICE_NM,
            P.PRODUCT_NM,
            P.AREA_TYPE,
            P.ORIGINAL_PRICE,
            P.SALE_PRICE,
            P.DISCOUNT_RATE,
            P.DISPLAY_ORDER,
            P.DISPLAY_YN,
            P.SALE_YN,
            P.REG_USER_ID,
            DATE_FORMAT(P.REG_DT, '%Y-%m-%d %H:%i') AS REG_DT,
            P.MOD_USER_ID,
            DATE_FORMAT(P.MOD_DT, '%Y-%m-%d %H:%i') AS MOD_DT
        FROM TB_PRODUCT P
        LEFT JOIN TB_CATEGORY C ON P.SERVICE_CD = C.SERVICE_CD
        WHERE 1=1
          AND P.DEL_YN = 'N'
        <if test="searchType != null and searchType != '' and searchWord != null and searchWord != ''">
            <choose>
                <when test="searchType == 'productNm'">
                    AND P.PRODUCT_NM LIKE CONCAT('%', #{searchWord}, '%')
                </when>
                <when test="searchType == 'productNo'">
                    AND P.PRODUCT_NO = #{searchWord}
                </when>
                <when test="searchType == 'serviceNm'">
                    AND C.SERVICE_NM LIKE CONCAT('%', #{searchWord}, '%')
                </when>
                <when test="searchType == 'all'">
                    AND (P.PRODUCT_NM LIKE CONCAT('%', #{searchWord}, '%')
                         OR C.SERVICE_NM LIKE CONCAT('%', #{searchWord}, '%'))
                </when>
            </choose>
        </if>
        <if test="serviceCd != null and serviceCd != ''">
            AND P.SERVICE_CD = #{serviceCd}
        </if>
        <if test="displayYn != null and displayYn != ''">
            AND P.DISPLAY_YN = #{displayYn}
        </if>
        <if test="saleYn != null and saleYn != ''">
            AND P.SALE_YN = #{saleYn}
        </if>
        <if test="areaType != null and areaType != ''">
            AND P.AREA_TYPE = #{areaType}
        </if>
        ORDER BY P.DISPLAY_ORDER ASC, P.PRODUCT_NO DESC
        <if test="rowLimit != null">
            LIMIT #{rowStrt}, #{rowLimit}
        </if>
    </select>

    <!-- 상품 상세 조회 -->
    <select id="selectProduct" parameterType="hashMap" resultType="hashMapCamel">
        SELECT
            P.PRODUCT_NO,
            P.SERVICE_CD,
            C.SERVICE_NM,
            P.PRODUCT_NM,
            P.PRODUCT_DESC,
            P.FILE_SEQ1,
            P.FILE_SEQ2,
            P.FILE_SEQ3,
            P.FILE_SEQ4,
            P.FILE_SEQ5,
            P.FILE_SEQ6,
            F1.FILE_PATH AS FILE_PATH1,
            F1.FILE_FAKE_NM AS FILE_NM1,
            F2.FILE_PATH AS FILE_PATH2,
            F2.FILE_FAKE_NM AS FILE_NM2,
            F3.FILE_PATH AS FILE_PATH3,
            F3.FILE_FAKE_NM AS FILE_NM3,
            F4.FILE_PATH AS FILE_PATH4,
            F4.FILE_FAKE_NM AS FILE_NM4,
            F5.FILE_PATH AS FILE_PATH5,
            F5.FILE_FAKE_NM AS FILE_NM5,
            F6.FILE_PATH AS FILE_PATH6,
            F6.FILE_FAKE_NM AS FILE_NM6,
            P.AREA_TYPE,
            P.ORIGINAL_PRICE,
            P.SALE_PRICE,
            P.DISCOUNT_RATE,
            P.SERVICE_TIME,
            P.SERVICE_INCLUDES,
            P.FEATURES,
            P.SERVICE_EFFECTS,
            P.WORK_PROCESS,
            P.DISPLAY_ORDER,
            P.DISPLAY_YN,
            P.SALE_YN,
            IFNULL(P.POPULAR_YN, 'N') AS POPULAR_YN,
            P.REG_USER_ID,
            DATE_FORMAT(P.REG_DT, '%Y-%m-%d %H:%i:%s') AS REG_DT,
            P.MOD_USER_ID,
            DATE_FORMAT(P.MOD_DT, '%Y-%m-%d %H:%i:%s') AS MOD_DT
        FROM TB_PRODUCT P
        LEFT JOIN TB_CATEGORY C ON P.SERVICE_CD = C.SERVICE_CD
        LEFT JOIN TB_FILE F1 ON P.FILE_SEQ1 = F1.FILE_SEQ
        LEFT JOIN TB_FILE F2 ON P.FILE_SEQ2 = F2.FILE_SEQ
        LEFT JOIN TB_FILE F3 ON P.FILE_SEQ3 = F3.FILE_SEQ
        LEFT JOIN TB_FILE F4 ON P.FILE_SEQ4 = F4.FILE_SEQ
        LEFT JOIN TB_FILE F5 ON P.FILE_SEQ5 = F5.FILE_SEQ
        LEFT JOIN TB_FILE F6 ON P.FILE_SEQ6 = F6.FILE_SEQ
        WHERE P.PRODUCT_NO = #{productNo}
          AND P.DEL_YN = 'N'
    </select>

    <!-- 상품 이미지 갤러리 조회 -->
    <select id="selectProductImages" parameterType="hashMap" resultType="hashMapCamel">
        SELECT
            FR.FILE_RELATE_SEQ,
            FR.FILE_SEQ,
            F.FILE_REAL_NM,
            F.FILE_FAKE_NM,
            F.FILE_PATH,
            F.FILE_EXTSN,
            F.FILE_SIZE,
            DATE_FORMAT(F.RGS_DT, '%Y-%m-%d %H:%i') AS RGS_DT
        FROM TB_FILE_RELATION FR
        INNER JOIN TB_FILE F ON FR.FILE_SEQ = F.FILE_SEQ
        WHERE FR.FILE_TRGET_SE = 'PRODUCT'
          AND FR.FILE_TRGET_SEQ = #{productNo}
        ORDER BY FR.FILE_RELATE_SEQ ASC
    </select>

    <!-- 상품 등록 -->
    <insert id="insertProduct" parameterType="hashMap" useGeneratedKeys="true" keyProperty="productNo">
        INSERT INTO TB_PRODUCT (
            SERVICE_CD,
            PRODUCT_NM,
            PRODUCT_DESC,
            FILE_SEQ1,
            FILE_SEQ2,
            FILE_SEQ3,
            FILE_SEQ4,
            FILE_SEQ5,
            FILE_SEQ6,
            AREA_TYPE,
            ORIGINAL_PRICE,
            SALE_PRICE,
            DISCOUNT_RATE,
            SERVICE_TIME,
            SERVICE_INCLUDES,
            FEATURES,
            SERVICE_EFFECTS,
            WORK_PROCESS,
            DISPLAY_ORDER,
            DISPLAY_YN,
            SALE_YN,
            POPULAR_YN,
            DEL_YN,
            REG_USER_ID,
            REG_DT
        ) VALUES (
            #{serviceCd},
            #{productNm},
            #{productDesc},
            #{fileSeq1},
            #{fileSeq2},
            #{fileSeq3},
            #{fileSeq4},
            #{fileSeq5},
            #{fileSeq6},
            #{areaType},
            #{originalPrice},
            #{salePrice},
            COALESCE(#{discountRate}, 0),
            #{serviceTime},
            #{serviceIncludes},
            #{features},
            #{serviceEffects},
            #{workProcess},
            COALESCE(#{displayOrder}, 999),
            COALESCE(#{displayYn}, 'Y'),
            COALESCE(#{saleYn}, 'Y'),
            COALESCE(#{popularYn}, 'N'),
            'N',
            #{regUserId},
            NOW()
        )
    </insert>

    <!-- 상품 수정 -->
    <update id="updateProduct" parameterType="hashMap">
        UPDATE TB_PRODUCT
        SET
            SERVICE_CD = #{serviceCd},
            PRODUCT_NM = #{productNm},
            PRODUCT_DESC = #{productDesc},
            <if test="fileSeq1 != null and fileSeq1 != ''">
            FILE_SEQ1 = #{fileSeq1},
            </if>
            <if test="fileSeq2 != null and fileSeq2 != ''">
            FILE_SEQ2 = #{fileSeq2},
            </if>
            <if test="fileSeq3 != null and fileSeq3 != ''">
            FILE_SEQ3 = #{fileSeq3},
            </if>
            <if test="fileSeq4 != null and fileSeq4 != ''">
            FILE_SEQ4 = #{fileSeq4},
            </if>
            <if test="fileSeq5 != null and fileSeq5 != ''">
            FILE_SEQ5 = #{fileSeq5},
            </if>
            <if test="fileSeq6 != null and fileSeq6 != ''">
            FILE_SEQ6 = #{fileSeq6},
            </if>
            AREA_TYPE = #{areaType},
            ORIGINAL_PRICE = #{originalPrice},
            SALE_PRICE = #{salePrice},
            DISCOUNT_RATE = #{discountRate},
            SERVICE_TIME = #{serviceTime},
            SERVICE_INCLUDES = #{serviceIncludes},
            FEATURES = #{features},
            SERVICE_EFFECTS = #{serviceEffects},
            WORK_PROCESS = #{workProcess},
            DISPLAY_ORDER = #{displayOrder},
            DISPLAY_YN = #{displayYn},
            SALE_YN = #{saleYn},
            POPULAR_YN = COALESCE(#{popularYn}, POPULAR_YN),
            MOD_USER_ID = #{modUserId},
            MOD_DT = NOW()
        WHERE PRODUCT_NO = #{productNo}
          AND DEL_YN = 'N'
    </update>

    <!-- 상품 삭제 (논리 삭제) -->
    <update id="deleteProduct" parameterType="hashMap">
        UPDATE TB_PRODUCT
        SET
            DEL_YN = 'Y',
            MOD_USER_ID = #{modUserId},
            MOD_DT = NOW()
        WHERE PRODUCT_NO = #{productNo}
    </update>

    <!-- 카테고리별 상품 목록 조회 (JOIN) -->
    <select id="selectProductWithCategory" parameterType="hashMap" resultType="hashMapCamel">
        SELECT
            P.PRODUCT_NO,
            P.SERVICE_CD,
            C.SERVICE_NM,
            C.SERVICE_ORDER,
            P.PRODUCT_NM,
            P.PRODUCT_DESC,
            P.AREA_TYPE,
            P.ORIGINAL_PRICE,
            P.SALE_PRICE,
            P.DISCOUNT_RATE,
            P.SERVICE_TIME,
            P.SERVICE_INCLUDES,
            P.FEATURES,
            P.SERVICE_EFFECTS,
            P.WORK_PROCESS,
            P.DISPLAY_ORDER,
            P.DISPLAY_YN,
            P.SALE_YN,
            IFNULL(P.POPULAR_YN, 'N') AS POPULAR_YN,
            DATE_FORMAT(P.REG_DT, '%Y-%m-%d %H:%i') AS REG_DT
        FROM TB_PRODUCT P
        LEFT JOIN TB_CATEGORY C ON P.SERVICE_CD = C.SERVICE_CD
        WHERE 1=1
          AND P.DEL_YN = 'N'
          AND C.USE_YN = 'Y'
        <if test="displayYn != null and displayYn != ''">
            AND P.DISPLAY_YN = #{displayYn}
        </if>
        <if test="saleYn != null and saleYn != ''">
            AND P.SALE_YN = #{saleYn}
        </if>
        <if test="serviceCd != null and serviceCd != ''">
            AND P.SERVICE_CD = #{serviceCd}
        </if>
        ORDER BY C.SERVICE_ORDER ASC, P.DISPLAY_ORDER ASC, P.PRODUCT_NO DESC
    </select>

    <!-- 특정 카테고리의 상품 목록 조회 -->
    <select id="selectProductByCategory" parameterType="hashMap" resultType="hashMapCamel">
        SELECT
            P.PRODUCT_NO,
            P.PRODUCT_NM,
            P.PRODUCT_DESC,
            P.AREA_TYPE,
            P.ORIGINAL_PRICE,
            P.SALE_PRICE,
            P.DISCOUNT_RATE,
            P.SERVICE_TIME,
            P.SERVICE_INCLUDES,
            P.FEATURES,
            P.SERVICE_EFFECTS,
            P.WORK_PROCESS,
            P.DISPLAY_ORDER,
            P.DISPLAY_YN,
            P.SALE_YN,
            IFNULL(P.POPULAR_YN, 'N') AS POPULAR_YN,
            DATE_FORMAT(P.REG_DT, '%Y-%m-%d') AS REG_DT
        FROM TB_PRODUCT P
        WHERE P.SERVICE_CD = #{serviceCd}
          AND P.DEL_YN = 'N'
          AND P.DISPLAY_YN = 'Y'
          AND P.SALE_YN = 'Y'
        ORDER BY P.DISPLAY_ORDER ASC, P.PRODUCT_NO DESC
    </select>

    <!-- 카테고리 목록 조회 -->
    <select id="selectCategoryList" resultType="hashMapCamel">
        SELECT
            SERVICE_CD,
            SERVICE_NM,
            SERVICE_ORDER,
            USE_YN,
            REG_USER_ID,
            DATE_FORMAT(REG_DT, '%Y-%m-%d %H:%i') AS REG_DT,
            MOD_USER_ID,
            DATE_FORMAT(MOD_DT, '%Y-%m-%d %H:%i') AS MOD_DT
        FROM TB_CATEGORY
        WHERE DEL_YN = 'N'
          AND USE_YN = 'Y'
        ORDER BY SERVICE_ORDER ASC, SERVICE_CD ASC
    </select>

    <!-- 카테고리 상세 조회 -->
    <select id="selectCategory" parameterType="hashMap" resultType="hashMapCamel">
        SELECT
            SERVICE_CD,
            SERVICE_NM,
            SERVICE_ORDER,
            USE_YN,
            REG_USER_ID,
            DATE_FORMAT(REG_DT, '%Y-%m-%d %H:%i:%s') AS REG_DT,
            MOD_USER_ID,
            DATE_FORMAT(MOD_DT, '%Y-%m-%d %H:%i:%s') AS MOD_DT
        FROM TB_CATEGORY
        WHERE SERVICE_CD = #{serviceCd}
          AND DEL_YN = 'N'
    </select>

</mapper>
