<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.cleaning.mapper.CategoryMapper">

    <!-- 서비스 카테고리 목록 조회 -->
    <select id="selectCategoryList" parameterType="hashMap" resultType="hashMapCamel">
        SELECT
            SERVICE_CD,
            SERVICE_NM,
            SERVICE_ORDER,
            USE_YN,
            REG_USER_ID,
            DATE_FORMAT(REG_DT, '%Y-%m-%d %H:%i') AS REG_DT,
            MOD_USER_ID,
            DATE_FORMAT(MOD_DT, '%Y-%m-%d %H:%i') AS MOD_DT
        FROM TB_CATEGORY
        WHERE DEL_YN = 'N'
        <if test="searchType != null and searchType != '' and searchWord != null and searchWord != ''">
            <choose>
                <when test="searchType == 'serviceCd'">
                    AND SERVICE_CD LIKE CONCAT('%', #{searchWord}, '%')
                </when>
                <when test="searchType == 'serviceNm'">
                    AND SERVICE_NM LIKE CONCAT('%', #{searchWord}, '%')
                </when>
                <otherwise>
                    AND (SERVICE_CD LIKE CONCAT('%', #{searchWord}, '%')
                     OR SERVICE_NM LIKE CONCAT('%', #{searchWord}, '%'))
                </otherwise>
            </choose>
        </if>
        <if test="useYn != null and useYn != ''">
            AND USE_YN = #{useYn}
        </if>
        ORDER BY SERVICE_ORDER ASC, SERVICE_CD ASC
        <if test="startIdx != null and viewRowCnt != null">
            LIMIT #{startIdx}, #{viewRowCnt}
        </if>
    </select>
    
    <!-- 서비스 카테고리 목록 개수 조회 -->
    <select id="selectCategoryListCnt" parameterType="hashMap" resultType="int">
        SELECT COUNT(*)
        FROM TB_CATEGORY
        WHERE DEL_YN = 'N'
        <if test="searchType != null and searchType != '' and searchWord != null and searchWord != ''">
            <choose>
                <when test="searchType == 'serviceCd'">
                    AND SERVICE_CD LIKE CONCAT('%', #{searchWord}, '%')
                </when>
                <when test="searchType == 'serviceNm'">
                    AND SERVICE_NM LIKE CONCAT('%', #{searchWord}, '%')
                </when>
                <otherwise>
                    AND (SERVICE_CD LIKE CONCAT('%', #{searchWord}, '%')
                     OR SERVICE_NM LIKE CONCAT('%', #{searchWord}, '%'))
                </otherwise>
            </choose>
        </if>
        <if test="useYn != null and useYn != ''">
            AND USE_YN = #{useYn}
        </if>
    </select>
    
    <!-- 서비스 카테고리 상세 조회 -->
    <select id="selectCategory" parameterType="string" resultType="hashMapCamel">
        SELECT
            SERVICE_CD,
            SERVICE_NM,
            SERVICE_ORDER,
            USE_YN,
            REG_USER_ID,
            DATE_FORMAT(REG_DT, '%Y-%m-%d %H:%i:%s') AS REG_DT,
            MOD_USER_ID,
            DATE_FORMAT(MOD_DT, '%Y-%m-%d %H:%i:%s') AS MOD_DT
        FROM TB_CATEGORY
        WHERE SERVICE_CD = #{serviceCd}
          AND DEL_YN = 'N'
    </select>
    
    <!-- 서비스 카테고리 등록 -->
    <insert id="insertCategory" parameterType="hashMap">
        INSERT INTO TB_CATEGORY (
            SERVICE_CD,
            SERVICE_NM,
            SERVICE_ORDER,
            USE_YN,
            DEL_YN,
            REG_USER_ID,
            REG_DT,
            MOD_USER_ID,
            MOD_DT
        ) VALUES (
            #{serviceCd},
            #{serviceNm},
            #{serviceOrder},
            #{useYn},
            'N',
            #{regUserId},
            NOW(),
            #{regUserId},
            NOW()
        )
    </insert>
    
    <!-- 서비스 카테고리 수정 -->
    <update id="updateCategory" parameterType="hashMap">
        UPDATE TB_CATEGORY
        SET SERVICE_NM = #{serviceNm},
            SERVICE_ORDER = #{serviceOrder},
            USE_YN = #{useYn},
            MOD_USER_ID = #{modUserId},
            MOD_DT = NOW()
        WHERE SERVICE_CD = #{serviceCd}
          AND DEL_YN = 'N'
    </update>
    
    <!-- 서비스 카테고리 삭제 (논리적 삭제) -->
    <update id="deleteCategory" parameterType="hashMap">
        UPDATE TB_CATEGORY
        SET DEL_YN = 'Y',
            MOD_USER_ID = #{modUserId},
            MOD_DT = NOW()
        WHERE SERVICE_CD = #{serviceCd}
    </update>
    
    <!-- 서비스 코드 중복 체크 -->
    <select id="checkDuplicateServiceCd" parameterType="string" resultType="int">
        SELECT COUNT(*)
        FROM TB_CATEGORY
        WHERE SERVICE_CD = #{serviceCd}
    </select>
    
    <!-- 최대 정렬 순서 조회 -->
    <select id="selectMaxServiceOrder" resultType="integer">
        SELECT COALESCE(MAX(SERVICE_ORDER), 0)
        FROM TB_CATEGORY
        WHERE DEL_YN = 'N'
    </select>
    
    <!-- 활성화된 서비스 카테고리 목록 (드롭다운용) -->
    <select id="selectActiveServiceCategoryList" resultType="hashMapCamel">
        SELECT 
            SERVICE_CD,
            SERVICE_NM,
            SERVICE_ORDER
        FROM TB_CATEGORY
        WHERE USE_YN = 'Y'
          AND DEL_YN = 'N'
        ORDER BY SERVICE_ORDER ASC, SERVICE_CD ASC
    </select>

</mapper>